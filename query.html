<!doctype html>
<html lang="en">
<head>
  <!-- Required meta tags -->
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">
  <meta name="description" content="A d3js example for neo4j">
  <meta name="author" content="Mic Wan">

  <title>D3js Example for neo4j</title>

  <!-- Bootstrap CSS -->
  <link rel="stylesheet" href="css/bootstrap.min.css">
  <link rel="stylesheet" href="css/font-awesome.min.css">
  <!-- Custom styles for this template -->
  <link rel="stylesheet" href="css/main.css">
</head>
<body>

  <div class="container-fluid">
    <div class="row">
      <div class="col col-12 col-md-12 form-inline">
        <input type="text" class="form-control form-control-sm" size="40px" id="cypher" placeholder="Cypher">
        <button type="button" class="btn btn-outline-primary btn-sm" id="btnSend">Send</button>
      </div>
    </div>
  </div>

  <hr/>

  <div class="container-fluid">
    <div class="row">
      <div class="col col-12 col-md-12" id="graphContainer">
        <svg id="resultSvg">
          <circle cx="40" cy="60" r="10"></circle>
          <circle cx="80" cy="60" r="10"></circle>
          <circle cx="120" cy="60" r="10"></circle>
        </svg>
      </div>
    </div>
  </div>

  <!-- jQuery first, then Popper.js, then Bootstrap JS -->
  <script src="js/jquery-3.3.1.min.js"></script>
  <script src="js/popper.min.js"></script>
  <script src="js/bootstrap.min.js"></script>
  <script src="js/d3.min.js"></script>
  <script type="text/javascript">
    "use strict";

    var neo4jAPIURL = 'http://localhost:7474/db/data/transaction/commit';
    var neo4jLogin = 'neo4j';
    var neo4jPassword = 'password';

    function removeAlert() {
      $('div.alert').remove();
    }

    function promptAlert(targetElement, msgText) {
      removeAlert();

      var alertDiv = $('<div class="alert alert-danger alert-dismissible fade show" role="alert"></div>');
      var alertCloseBtn = $('<button type="button" class="close" data-dismiss="alert" aria-label="Close"></button>');
      alertCloseBtn.append($('<i class="fa fa-times" aria-hidden="true"></i>'));
      alertDiv.append(alertCloseBtn);

      alertDiv.append(msgText);
      targetElement.prepend(alertDiv);
    }

    function neo4jLoginForAjax() {
      $.ajaxSetup({
        contentType: 'application/json',
        beforeSend: function(xhr) {
          xhr.setRequestHeader ('Authorization', 'Basic ' + btoa(neo4jLogin + ':' + neo4jPassword));
        }
      });
    }

    function submitQuery() {
      removeAlert();

      var queryStr = $.trim($('#cypher').val());
      if (queryStr == '') {
        promptAlert($('#graphContainer'), 'Error: cypher cannot be empty !');
        return;
      }

      var jqxhr = $.post(neo4jAPIURL, '{"statements":[{"statement":"' + queryStr + '", "resultDataContents":["graph"]}]}', 
        function(data) {
          console.log(JSON.stringify(data));
          if (data.errors != null && data.errors.length > 0) {
            promptAlert($('#graphContainer'), 'Error: ' + data.errors[0].message + '(' + data.errors[0].code + ')');
            return;
          }
        }, 'json');

      jqxhr.fail(function(data) {
        promptAlert($('#graphContainer'), 'Error: submit cypher but got error return (' + data + ')');
      });
    }

    //Page Init
    $(function() {
      neo4jLoginForAjax();

      $('#cypher').keyup(function(e) {
        if(e.which == 13) {
          submitQuery();
        }
      });

      $('#btnSend').click(submitQuery);
    });
  </script>
</body>
</html>